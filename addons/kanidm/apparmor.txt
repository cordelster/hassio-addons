#include <tunables/global>

profile kanidm flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>

  # Required capabilities
  capability chown,
  capability dac_override,
  capability fowner,
  capability fsetid,
  capability setuid,
  capability setgid,
  capability net_bind_service,
  capability sys_resource,

  # Network access
  network inet stream,
  network inet6 stream,
  network inet dgram,
  network inet6 dgram,

  # File access - data and config directories
  /data/ r,
  /data/** rwk,
  /config/ r,
  /config/** rwk,
  /ssl/ r,
  /ssl/** r,
  /tmp/ r,
  /tmp/** rw,
  /root/.cache/ rw,
  /root/.cache/** rw,
  /usr/local/bin/ r,
  /usr/local/bin/** rwix,
  /usr/local/lib/ r,
  /usr/local/lib/** rix,
  /usr/local/share/ r,
  /usr/local/share/** r,
  /var/log/kanidm-sync/ r,
  /var/log/kanidm-sync/** rw,
  /var/log/kanidm-backup.log rw,
  /run/kanidmd/ r,
  /run/kanidmd/** rw,

  # PTY/terminal access for expect
  /dev/pts/* rw,
  /dev/ptmx rw,

  # Cron support
  /etc/crontabs/ r,
  /etc/crontabs/** rw,
  /var/spool/cron/ rw,
  /var/spool/cron/** rw,
  /var/spool/cron/crontabs/ rw,
  /var/spool/cron/crontabs/** rw,

  # System information (read-only)
  /etc/resolv.conf r,
  /etc/hosts r,
  /etc/nsswitch.conf r,
  /etc/passwd r,
  /etc/group r,
  /etc/shadow r,
  /etc/ssl/** r,
  /etc/kanidm/ rw,
  /etc/kanidm/** rw,
  /usr/share/kanidm/** r,
  /proc/ r,
  /proc/** r,
  /sys/fs/cgroup/** r,

  # Explicitly deny dangerous areas
  deny /proc/*/mem r,
  deny /sys/kernel/security/** rwx,
  deny /dev/kmem rwx,
  deny /dev/mem rwx,
  deny /proc/kcore r,

  # Binary execution
  /usr/bin/kanidmd ix,
  /usr/bin/kanidm ix,
  /usr/local/bin/kanidm-sync ix,
  /usr/local/bin/kanidm-ipa-sync ix,
  /usr/local/bin/backup_kanidm.sh ix,
  /usr/local/bin/health_check.sh ix,
  /usr/local/bin/* ix,
  /bin/bash ix,
  /bin/sh ix,
  /bin/busybox ix,
  /bin/ls ix,
  /usr/bin/env ix,
  /usr/bin/readlink ix,
  /usr/bin/jq ix,
  /usr/bin/expect ix,
  /usr/bin/curl ix,
  /usr/bin/openssl ix,
  /usr/bin/pgrep ix,
  /usr/bin/crontab ix,
  /usr/bin/du ix,
  /usr/bin/date ix,
  /usr/bin/tee ix,

  # Home Assistant bashio library (bashio is a symlink)
  /usr/bin/bashio rix,
  /usr/lib/bashio/bashio rix,
  /usr/lib/bashio/** r,

  # Cron daemon
  /usr/sbin/crond ix,

  # s6-overlay supervision suite (Home Assistant's init system)
  /init rix,
  /bin/s6-* rix,
  /usr/bin/s6-* rix,
  /usr/bin/s6-overlay-suexec rix,
  /command/** rix,
  /package/** rix,

  # Allow reading init and s6 config
  /run.sh rix,
  /etc/services r,
  /etc/cont-init.d/* rix,
  /etc/s6/** r,
  /etc/s6-overlay/** r,
  /etc/fix-attrs.d/** r,

  # s6 runtime directories (full access for s6-overlay to create/execute files)
  /run/ rw,
  /run/** rwkix,
}
